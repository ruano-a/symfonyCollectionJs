(function(){return"function"!=typeof window.CustomEvent&&void(window.CustomEvent=function(a,b){b=b||{bubbles:!1,cancelable:!1,detail:null};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c})})();var formCollection=function(a,b,c){var d,e="prototypeModified",f="addMethodCalled",g="deleteMethodCalled",h="clearMethodCalled",j="refreshAttributesMethodCalled",k=function(c,a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},l=function(a){if("function"==typeof Event)return new Event(a);var b=document.createEvent("Event");return b.initEvent(a,!0,!0),b};if(b===void 0||"object"==typeof b){var m={max_elems:100,call_post_add_on_init:!1,post_add:function(a,b,c){return!0},post_delete:function(a,b,c){return!0},post_up:function(a,b,c){return!0},post_down:function(a,b,c){return!0},other_btn_add:null,btn_add_selector:".collection-add",btn_delete_selector:".collection-delete",btn_up_selector:".collection-up",btn_down_selector:".collection-down",prototype_name:"__name__"};d=k(m,b)}else if("string"==typeof b){if(-1===["add","delete","clear","refreshAttributes"].indexOf(b))return console.log("Invalid options"),!1;if("delete"===b&&void 0===c)return console.log("Missing index"),!1}a instanceof Node&&(a=[a]);for(var o,p=0;p<a.length;p++){switch(o=a[p],b){case"add":return void o.dispatchEvent(l(f));break;case"delete":return void o.dispatchEvent(new CustomEvent(g,{detail:c}));break;case"clear":return void o.dispatchEvent(l(h));break;case"refreshAttributes":return void o.dispatchEvent(new CustomEvent(j,{detail:c}));}var q=o.getAttribute("data-prototype"),r=o.children.length,s=[];o.addEventListener(e,function(a){a.target!==a.currentTarget||(s=[],q=this.getAttribute("data-prototype"),w(),A(0))}),o.addEventListener(f,function(a){G(formCollection.POST_ADD_CONTEXT.ADD_METHOD)}),o.addEventListener(g,function(a){var b=a.detail,c=o.children[b];H(c),d.post_delete(c,formCollection.POST_DELETE_CONTEXT.DELETE_METHOD,b)}),o.addEventListener(h,function(a){o.textContent="",r=0}),o.addEventListener(j,function(a){var b=a.detail;A(b)});var t=function(a,b){var c={path:a,attributes:b};return c},u=function(a){var b=document.createElement("div");return b.innerHTML=a.trim(),b.firstChild},v=function(a,b){var c=y(a,d.prototype_name);if(0<Object.keys(c).length&&s.push(t(b,c)),!("data-prototype"in c))for(var e=a.children,f=0;f<e.length;f++)v(e[f],b.concat([f]))},w=function(){var a=u(q);v(a,[])},x=function(a){for(var b=a.querySelectorAll(d.btn_add_selector),c=0;c<b.length;c++)b[c].addEventListener("click",function(){var b=F(a);d.post_add(b,formCollection.POST_ADD_CONTEXT.BTN_ADD,C(b))});for(var e=a.querySelectorAll(d.btn_delete_selector),c=0;c<e.length;c++)e[c].addEventListener("click",function(){var b=C(a);H(a),d.post_delete(a,formCollection.POST_DELETE_CONTEXT.BTN_DELETE,b)});for(var f=a.querySelectorAll(d.btn_up_selector),c=0;c<f.length;c++)f[c].addEventListener("click",function(){var b=C(a),c=I(a);c&&d.post_up(a,c,b)});for(var g=a.querySelectorAll(d.btn_down_selector),c=0;c<g.length;c++)g[c].addEventListener("click",function(){var b=C(a),c=J(a);c&&d.post_down(a,c,b)})},y=function(a,b){for(var c,d={},e=0;e<a.attributes.length;e++)c=a.attributes[e],c.value&&-1!==c.value.indexOf(b)&&(d[c.name]=c.value);return d},z=function(a,b){for(var c=new RegExp(d.prototype_name,"g"),f=0;f<s.length;f++){for(var g,h=s[f],k=a,m=0;m<h.path.length;m++)g=h.path[m],k=k.children[g];for(var n=Object.keys(h.attributes),m=0;m<n.length;m++){var o=n[m],p=h.attributes[o];k.setAttribute(o,p.replace(c,b))}"data-prototype"in k.attributes&&k.dispatchEvent(l(e))}},A=function(a){for(var b=o.children,c=a;c<b.length;c++)z(b[c],c)},B=function(a){void 0===a&&(a=r);var b=q,c=new RegExp(d.prototype_name,"g");b=b.replace(c,a);var e=u(b);return x(e),e},C=function(a){for(var b=0;null!=(a=a.previousElementSibling);)b++;return b},D=function(a,b){a.insertAdjacentElement("beforebegin",b)},E=function(a,b){a.insertAdjacentElement("afterend",b)},F=function(a){if(r>=d.max_elems)return!1;var b=B(C(a)+1);return E(a,b),r++,A(C(a)+2),b},G=function(a){if(r>=d.max_elems)return!1;var b=B();o.appendChild(b),r++,d.post_add(b,a,r-1)},H=function(a){var b=C(a);a.parentNode.removeChild(a),r--,A(b)},I=function(a){var b=a.previousElementSibling;if(!b)return!1;var c=C(b);return D(b,a),z(a,c),z(b,c+1),b},J=function(a){var b=a.nextElementSibling;if(!b)return!1;var c=C(b);return E(b,a),z(a,c),z(b,c-1),b},K=function(){for(var a,b=0;b<o.children.length;b++)a=o.children[b],x(a),d.call_post_add_on_init&&d.post_add(a,formCollection.POST_ADD_CONTEXT.INIT,b)};if(K(),w(),d.other_btn_add){var L=null;if("string"==typeof d.other_btn_add?L=document.querySelectorAll(d.other_btn_add):d.other_btn_add instanceof Node?L=[d.other_btn_add]:formCollection.jQuery&&d.other_btn_add instanceof formCollection.jQuery||d.other_btn_add instanceof NodeList?L=d.other_btn_add:console.log("other_btn_add: bad value, can be a selector or nodes, or a jQuery object."),L)for(var p=0;p<L.length;p++)L[p].addEventListener("click",function(){G(formCollection.POST_ADD_CONTEXT.OTHER_BTN_ADD)})}}};formCollection.POST_ADD_CONTEXT={BTN_ADD:4,OTHER_BTN_ADD:8,INIT:15,ADD_METHOD:16},formCollection.POST_DELETE_CONTEXT={BTN_DELETE:23,DELETE_METHOD:42},function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof module&&module.exports?module.exports=b():a.returnExports=b()}(this,function(){return formCollection});