(function(){return"function"!=typeof window.CustomEvent&&void(window.CustomEvent=function(a,b){b=b||{bubbles:!1,cancelable:!1,detail:null};let c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c})})();let formCollection=function(a,b,c){let d,e="prototypeModified",f="addMethodCalled",g="deleteMethodCalled",h="clearMethodCalled",j="refreshAttributesMethodCalled",k=function(c,a){for(let b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},l=function(a){if("function"==typeof Event)return new Event(a);let b=document.createEvent("Event");return b.initEvent(a,!0,!0),b};if(b===void 0||"object"==typeof b){d=k({max_elems:100,call_pre_add_on_init:!1,call_post_add_on_init:!1,pre_add:function(){return!0},post_add:function(){return!0},pre_delete:function(){return!0},post_delete:function(){return!0},pre_up:function(){return!0},post_up:function(){return!0},pre_down:function(){return!0},post_down:function(){return!0},other_btn_add:null,btn_add_selector:".collection-add",btn_delete_selector:".collection-delete",btn_up_selector:".collection-up",btn_down_selector:".collection-down",prototype_name:"__name__"},b)}else if("string"==typeof b){if(-1===["add","delete","clear","refreshAttributes"].indexOf(b))return console.error("Invalid options"),!1;if("delete"===b&&void 0===c)return console.error("Missing index"),!1}a instanceof Node&&(a=[a]);for(let k,m=0;m<a.length;m++){switch(k=a[m],b){case"add":return void k.dispatchEvent(l(f));break;case"delete":return void k.dispatchEvent(new CustomEvent(g,{detail:c}));break;case"clear":return void k.dispatchEvent(l(h));break;case"refreshAttributes":return void k.dispatchEvent(new CustomEvent(j,{detail:c}));}let i=k.getAttribute("data-prototype"),o=k.children.length,n=[];k.addEventListener(e,function(a){a.target!==a.currentTarget||(n=[],i=this.getAttribute("data-prototype"),s(),w(0))}),k.addEventListener(f,function(a){C(formCollection.ADD_CONTEXT.ADD_METHOD)}),k.addEventListener(g,function(a){let b=a.detail,c=k.children[b];!1===d.pre_delete(c,formCollection.DELETE_CONTEXT.DELETE_METHOD,b)||(D(c),d.post_delete(c,formCollection.DELETE_CONTEXT.DELETE_METHOD,b))}),k.addEventListener(h,function(a){k.textContent="",o=0}),k.addEventListener(j,function(a){let b=a.detail;w(b)});let p=function(a,b){let c={path:a,attributes:b};return c},q=function(a){let b=document.createElement("div");return b.innerHTML=a.trim(),b.firstChild},r=function(a,b){let c=u(a,d.prototype_name);if(0<Object.keys(c).length&&n.push(p(b,c)),!("data-prototype"in c)){let c=a.children;for(let a=0;a<c.length;a++)r(c[a],b.concat([a]))}},s=function(){let a=q(i);r(a,[])},t=function(a){let b=a.querySelectorAll(d.btn_add_selector);for(let c=0;c<b.length;c++)b[c].addEventListener("click",function(){let b=y(a)+1;if(!1!==d.pre_add(formCollection.ADD_CONTEXT.BTN_ADD,b)){let c=B(a);d.post_add(c,formCollection.ADD_CONTEXT.BTN_ADD,b)}});let c=a.querySelectorAll(d.btn_delete_selector);for(let b=0;b<c.length;b++)c[b].addEventListener("click",function(){let b=y(a);!1===d.pre_delete(a,formCollection.DELETE_CONTEXT.BTN_DELETE,b)||(D(a),d.post_delete(a,formCollection.DELETE_CONTEXT.BTN_DELETE,b))});let e=a.querySelectorAll(d.btn_up_selector);for(let b=0;b<e.length;b++)e[b].addEventListener("click",function(){let b=y(a),c=a.previousElementSibling;c&&!1!==d.pre_up(a,c,b)&&(c=E(a),c&&d.post_up(a,c,b))});let f=a.querySelectorAll(d.btn_down_selector);for(let b=0;b<f.length;b++)f[b].addEventListener("click",function(){let b=y(a),c=a.nextElementSibling;c&&!1!==d.pre_down(a,c,b)&&(c=F(a),c&&d.post_down(a,c,b))})},u=function(a,b){let c={};for(let d,e=0;e<a.attributes.length;e++)d=a.attributes[e],d.value&&-1!==d.value.indexOf(b)&&(c[d.name]=d.value);return c},v=function(a,b){let c=new RegExp(d.prototype_name,"g");for(let d=0;d<n.length;d++){let f=n[d],g=a;for(let a,b=0;b<f.path.length;b++)a=f.path[b],g=g.children[a];let h=Object.keys(f.attributes);for(let a=0;a<h.length;a++){let d=h[a],e=f.attributes[d];g.setAttribute(d,e.replace(c,b))}"data-prototype"in g.attributes&&g.dispatchEvent(l(e))}},w=function(a){let b=k.children;for(let c=a;c<b.length;c++)v(b[c],c)},x=function(a){void 0===a&&(a=o);let b=i,c=new RegExp(d.prototype_name,"g");b=b.replace(c,a);let e=q(b);return t(e),e},y=function(a){let b=0;for(;null!=(a=a.previousElementSibling);)b++;return b},z=function(a,b){a.insertAdjacentElement("beforebegin",b)},A=function(a,b){a.insertAdjacentElement("afterend",b)},B=function(a){if(o>=d.max_elems)return!1;let b=x(y(a)+1);return A(a,b),o++,w(y(a)+2),b},C=function(a){if(o>=d.max_elems)return!1;if(!1!==d.pre_add(a,o)){let b=x();k.appendChild(b),o++,d.post_add(b,a,o-1)}},D=function(a){let b=y(a);a.parentNode.removeChild(a),o--,w(b)},E=function(a){let b=a.previousElementSibling;if(!b)return!1;let c=y(b);return z(b,a),v(a,c),v(b,c+1),b},F=function(a){let b=a.nextElementSibling;if(!b)return!1;let c=y(b);return A(b,a),v(a,c),v(b,c-1),b},G=function(){for(let a=0;a<k.children.length;a++){d.call_pre_add_on_init&&d.pre_add(formCollection.ADD_CONTEXT.INIT,a);let b=k.children[a];t(b),d.call_post_add_on_init&&d.post_add(b,formCollection.ADD_CONTEXT.INIT,a)}};if(G(),s(),d.other_btn_add){let a=null;if("string"==typeof d.other_btn_add?a=document.querySelectorAll(d.other_btn_add):d.other_btn_add instanceof Node?a=[d.other_btn_add]:formCollection.jQuery&&d.other_btn_add instanceof formCollection.jQuery||d.other_btn_add instanceof NodeList?a=d.other_btn_add:console.error("other_btn_add: bad value, can be a selector or nodes, or a jQuery object."),a)for(let b=0;b<a.length;b++)a[b].addEventListener("click",function(){C(formCollection.ADD_CONTEXT.OTHER_BTN_ADD)})}}};formCollection.ADD_CONTEXT={BTN_ADD:4,OTHER_BTN_ADD:8,INIT:15,ADD_METHOD:16},formCollection.DELETE_CONTEXT={BTN_DELETE:23,DELETE_METHOD:42},formCollection.POST_ADD_CONTEXT=formCollection.ADD_CONTEXT,formCollection.POST_DELETE_CONTEXT=formCollection.DELETE_CONTEXT,function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof module&&module.exports?module.exports=b():a.returnExports=b()}(this,function(){return formCollection});